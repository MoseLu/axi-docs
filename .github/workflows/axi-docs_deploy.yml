name: Build & Deploy AXI Docs

on:
  push:
    branches: [main, master]
    paths-ignore:
      - 'uploads/md/**'
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ„å»ºé™æ€ç«™ç‚¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          run_install: false      # è®©ä¸‹é¢ä¸€æ­¥æ˜¾å¼å®‰è£…ï¼Œæ—¥å¿—æ›´æ¸…æ™°

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ£€æŸ¥æ„å»ºç›®å½•
        run: |
          echo "ğŸ” æ£€æŸ¥æ„å»ºç›®å½•..."
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "ç›®å½•å†…å®¹:"
          ls -la
          echo "docs ç›®å½•å†…å®¹:"
          ls -la docs/ || echo "docs ç›®å½•ä¸å­˜åœ¨"
          echo ".vitepress ç›®å½•å†…å®¹:"
          ls -la docs/.vitepress/ || echo ".vitepress ç›®å½•ä¸å­˜åœ¨"

      - name: æ„å»ºæ–‡æ¡£
        run: pnpm run docs:build

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "docs/.vitepress/dist ç›®å½•æ˜¯å¦å­˜åœ¨:"
          if [ -d "docs/.vitepress/dist" ]; then
            echo "âœ… docs/.vitepress/dist ç›®å½•å­˜åœ¨"
            echo "æ„å»ºäº§ç‰©å†…å®¹:"
            ls -la docs/.vitepress/dist/
            echo "æ–‡ä»¶æ•°é‡:"
            find docs/.vitepress/dist -type f | wc -l
            echo "å‰10ä¸ªæ–‡ä»¶:"
            find docs/.vitepress/dist -type f | head -10
            echo "æ„å»ºäº§ç‰©å¤§å°:"
            du -sh docs/.vitepress/dist/
          else
            echo "âŒ docs/.vitepress/dist ç›®å½•ä¸å­˜åœ¨"
            echo "ğŸ” æŸ¥æ‰¾å¯èƒ½çš„æ„å»ºäº§ç‰©ç›®å½•:"
            find . -name "dist" -type d 2>/dev/null || echo "æœªæ‰¾åˆ° dist ç›®å½•"
            echo "ğŸ” å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            echo "ğŸ” docs ç›®å½•å†…å®¹:"
            ls -la docs/ || echo "docs ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: å‡†å¤‡ä¸Šä¼ ç›®å½•
        run: |
          echo "ğŸ”§ å‡†å¤‡ä¸Šä¼ ç›®å½•..."
          # ç¡®ä¿æ„å»ºäº§ç‰©ç›®å½•å­˜åœ¨ä¸”ä¸ä¸ºç©º
          if [ ! -d "docs/.vitepress/dist" ]; then
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦ä¸ºç©º
          if [ -z "$(ls -A docs/.vitepress/dist)" ]; then
            echo "âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸ºç©º"
            exit 1
          fi
          
          echo "âœ… æ„å»ºäº§ç‰©å‡†å¤‡å®Œæˆ"
          echo "æ„å»ºäº§ç‰©å†…å®¹:"
          ls -la docs/.vitepress/dist/
          
          # åˆ›å»ºå‹ç¼©åŒ…ä»¥ç¡®ä¿ç›®å½•ç»“æ„å®Œæ•´
          echo "ğŸ“¦ åˆ›å»ºæ„å»ºäº§ç‰©å‹ç¼©åŒ…..."
          tar -czf dist-axi-docs.tar.gz -C docs/.vitepress dist
          
          echo "âœ… å‹ç¼©åŒ…åˆ›å»ºå®Œæˆ"
          echo "ğŸ“Š å‹ç¼©åŒ…å¤§å°: $(du -h dist-axi-docs.tar.gz | cut -f1)"
          echo "ğŸ“ å‹ç¼©åŒ…å†…å®¹é¢„è§ˆ:"
          tar -tzf dist-axi-docs.tar.gz | head -20

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist-axi-docs
          path: |
            docs/.vitepress/dist/
            dist-axi-docs.tar.gz
          retention-days: 1
          if-no-files-found: error

      - name: éªŒè¯ä¸Šä¼ 
        run: |
          echo "ğŸ” éªŒè¯ä¸Šä¼ ç»“æœ..."
          echo "ä¸Šä¼ é€€å‡ºç : $?"
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "æ„å»ºäº§ç‰©ç›®å½•å†…å®¹:"
          ls -la docs/.vitepress/dist/ || echo "æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ éƒ¨ç½²è¯´æ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deployment-info:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²ä¿¡æ¯
        run: |
          echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
          echo "=========================================="
          echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
          echo "- é¡¹ç›®åç§°: ${{ github.repository }}"
          echo "- æ„å»ºID: ${{ github.run_id }}"
          echo "- åˆ†æ”¯: ${{ github.ref_name }}"
          echo "- æäº¤: ${{ github.sha }}"
          echo ""
          echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
          echo "- äº§ç‰©åç§°: dist-axi-docs"
          echo "- äº§ç‰©è·¯å¾„: docs/.vitepress/dist/"
          echo "- ä¿ç•™å¤©æ•°: 1å¤©"
          echo ""
          echo "ğŸš€ éƒ¨ç½²æµç¨‹:"
          echo "- axi-deploy å°†é€šè¿‡ workflow_run äº‹ä»¶è‡ªåŠ¨è§¦å‘éƒ¨ç½²"
          echo "- éƒ¨ç½²å°†åœ¨æ„å»ºå®Œæˆåè‡ªåŠ¨å¼€å§‹"
          echo "- æ— éœ€æ‰‹åŠ¨æ“ä½œ"
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€:"
          echo "- ç”Ÿäº§ç¯å¢ƒ: https://redamancy.com.cn/docs/"
          echo "=========================================="

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è§¦å‘è¿œç¨‹éƒ¨ç½² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  trigger-deploy:
    needs: build
    runs-on: ubuntu-latest

    env:                      # æŠŠéœ€è¦çš„å€¼å…¨éƒ¨æ³¨å…¥ç¯å¢ƒå˜é‡
      RUN_ID: ${{ needs.build.outputs.run_id }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_KEY: ${{ secrets.SERVER_KEY }}
      DEPLOY_CENTER_PAT: ${{ secrets.DEPLOY_CENTER_PAT }}

    steps:
      - name: è§¦å‘éƒ¨ç½²
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPLOY_CENTER_PAT }}
          script: |
            // 1. æ‰“åŒ…æœºå¯†ï¼ˆä¸ºäº†é¿å¼€ workflow_call 10 æ¡ secret é™åˆ¶ï¼‰
            const deploySecrets = Buffer.from(JSON.stringify({
              SERVER_HOST: process.env.SERVER_HOST,
              SERVER_PORT: process.env.SERVER_PORT,
              SERVER_USER: process.env.SERVER_USER,
              SERVER_KEY : process.env.SERVER_KEY,
              DEPLOY_CENTER_PAT: process.env.DEPLOY_CENTER_PAT
            })).toString('base64');

            // 2. Nginx ç‰‡æ®µç”¨æ¨¡æ¿å­—ç¬¦ä¸²å†™æ›´æ˜“è¯»
            const nginxConfig = `
              location /docs/ {
                alias /srv/static/axi-docs/;
                index index.html;
                try_files $uri $uri/ /docs/index.html;

                add_header Cache-Control "no-cache, no-store, must-revalidate" always;
                add_header Pragma        "no-cache" always;
                add_header Expires       "0"        always;
              }

              location = /docs { return 301 /docs/; }
            `.trim();

            console.log('ğŸš€  è§¦å‘ axi-deploy/main-deployment.yml â€¦');
            console.log('é¡¹ç›®åç§°:', context.repo.repo);
            console.log('æºä»“åº“:', `${context.repo.owner}/${context.repo.repo}`);
            console.log('è¿è¡ŒID:', process.env.RUN_ID);
            console.log('è§¦å‘æ—¶é—´:', new Date().toISOString());
            console.log('å·¥ä½œæµåç§°:', context.workflow);
            console.log('åˆ†æ”¯:', context.ref);
            console.log('æäº¤:', context.sha);

            // ç­‰å¾…ä¸€æ®µæ—¶é—´ç¡®ä¿artifactå®Œå…¨å¯ç”¨
            console.log('â³ ç­‰å¾…artifactå®Œå…¨å¯ç”¨...');
            await new Promise(resolve => setTimeout(resolve, 5000)); // ç­‰å¾…5ç§’
            
            // å†æ¬¡æ£€æŸ¥ workflow run çŠ¶æ€
            console.log('ğŸ” æ£€æŸ¥ workflow run çŠ¶æ€...');
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: process.env.RUN_ID
            });
            
            console.log('ğŸ“Š Workflow run çŠ¶æ€:', run.data.status);
            console.log('ğŸ“Š Workflow run ç»“è®º:', run.data.conclusion);
            
            if (run.data.status !== 'completed') {
              console.log('â³ Workflow run å°šæœªå®Œæˆï¼Œç»§ç»­ç­‰å¾…...');
              await new Promise(resolve => setTimeout(resolve, 5000)); // å†ç­‰å¾…5ç§’
            }

            await github.rest.actions.createWorkflowDispatch({
              owner: 'MoseLu',
              repo:  'axi-deploy',
              workflow_id: 'main-deployment.yml',
              ref: 'master',
              inputs: {
                project      : context.repo.repo,
                source_repo  : `${context.repo.owner}/${context.repo.repo}`,
                run_id       : process.env.RUN_ID,
                deploy_type  : 'static',
                nginx_config : nginxConfig,
                test_url     : 'https://redamancy.com.cn/docs/',
                deploy_secrets: deploySecrets
              }
            });

            console.log('âœ…  éƒ¨ç½²å·¥ä½œæµå·²æˆåŠŸè§¦å‘ï¼');
