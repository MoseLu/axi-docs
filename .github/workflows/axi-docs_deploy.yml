name: Build & Deploy AXI Docs

on:
  push:
    branches: [main, master]
    paths-ignore:
      - 'uploads/md/**'
  workflow_dispatch:

jobs:
  # ────────────────────── 构建静态站点 ──────────────────────
  build:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          run_install: false      # 让下面一步显式安装，日志更清晰

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 安装依赖
        run: pnpm install --frozen-lockfile

      - name: 检查构建目录
        run: |
          echo "🔍 检查构建目录..."
          echo "当前目录: $(pwd)"
          echo "目录内容:"
          ls -la
          echo "docs 目录内容:"
          ls -la docs/ || echo "docs 目录不存在"
          echo ".vitepress 目录内容:"
          ls -la docs/.vitepress/ || echo ".vitepress 目录不存在"

      - name: 构建文档
        run: pnpm run docs:build

      - name: 验证构建产物
        run: |
          echo "🔍 验证构建产物..."
          echo "当前目录: $(pwd)"
          echo "docs/.vitepress/dist 目录是否存在:"
          if [ -d "docs/.vitepress/dist" ]; then
            echo "✅ docs/.vitepress/dist 目录存在"
            echo "构建产物内容:"
            ls -la docs/.vitepress/dist/
            echo "文件数量:"
            find docs/.vitepress/dist -type f | wc -l
            echo "前10个文件:"
            find docs/.vitepress/dist -type f | head -10
            echo "构建产物大小:"
            du -sh docs/.vitepress/dist/
          else
            echo "❌ docs/.vitepress/dist 目录不存在"
            echo "🔍 查找可能的构建产物目录:"
            find . -name "dist" -type d 2>/dev/null || echo "未找到 dist 目录"
            echo "🔍 当前目录内容:"
            ls -la
            echo "🔍 docs 目录内容:"
            ls -la docs/ || echo "docs 目录不存在"
            exit 1
          fi

      - name: 准备上传目录
        run: |
          echo "🔧 准备上传目录..."
          # 确保构建产物目录存在且不为空
          if [ ! -d "docs/.vitepress/dist" ]; then
            echo "❌ 构建产物目录不存在"
            exit 1
          fi
          
          # 检查构建产物是否为空
          if [ -z "$(ls -A docs/.vitepress/dist)" ]; then
            echo "❌ 构建产物目录为空"
            exit 1
          fi
          
          echo "✅ 构建产物准备完成"
          echo "构建产物内容:"
          ls -la docs/.vitepress/dist/

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: dist-axi-docs
          path: docs/.vitepress/dist/
          retention-days: 7
          if-no-files-found: error

      - name: 验证上传
        run: |
          echo "🔍 验证上传结果..."
          echo "上传退出码: $?"
          echo "当前目录: $(pwd)"
          echo "构建产物目录内容:"
          ls -la docs/.vitepress/dist/ || echo "构建产物目录不存在"

  # ────────────────────── 部署说明 ──────────────────────
  deployment-info:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: 部署信息
        run: |
          echo "🎉 构建完成！"
          echo "=========================================="
          echo "📋 构建信息:"
          echo "- 项目名称: ${{ github.repository }}"
          echo "- 构建ID: ${{ github.run_id }}"
          echo "- 分支: ${{ github.ref_name }}"
          echo "- 提交: ${{ github.sha }}"
          echo ""
          echo "📦 构建产物:"
          echo "- 产物名称: dist-axi-docs"
          echo "- 产物路径: docs/.vitepress/dist/"
          echo "- 保留天数: 7天"
          echo ""
          echo "🚀 部署流程:"
          echo "- axi-deploy 将通过 workflow_run 事件自动触发部署"
          echo "- 部署将在构建完成后自动开始"
          echo "- 无需手动操作"
          echo ""
          echo "🌐 访问地址:"
          echo "- 生产环境: https://redamancy.com.cn/docs/"
          echo "=========================================="
