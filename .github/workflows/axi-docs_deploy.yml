name: Build & Deploy AXI Docs

on:
  push:
    branches: [main, master]
    paths-ignore:
      - 'uploads/md/**'
  workflow_dispatch:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ„å»ºé™æ€ç«™ç‚¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ubuntu-latest
    outputs:
      run_id: ${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          run_install: false      # è®©ä¸‹é¢ä¸€æ­¥æ˜¾å¼å®‰è£…ï¼Œæ—¥å¿—æ›´æ¸…æ™°

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºæ–‡æ¡£
        run: pnpm run docs:build

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.event.repository.name }}
          path: docs/.vitepress/dist/
          retention-days: 7

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è§¦å‘è¿œç¨‹éƒ¨ç½² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  trigger-deploy:
    needs: build
    runs-on: ubuntu-latest

    env:                      # æŠŠéœ€è¦çš„å€¼å…¨éƒ¨æ³¨å…¥ç¯å¢ƒå˜é‡
      RUN_ID: ${{ needs.build.outputs.run_id }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_PORT: ${{ secrets.SERVER_PORT }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_KEY: ${{ secrets.SERVER_KEY }}
      DEPLOY_CENTER_PAT: ${{ secrets.DEPLOY_CENTER_PAT }}

    steps:
      - name: è§¦å‘éƒ¨ç½²
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPLOY_CENTER_PAT }}
          script: |
            // 1. æ‰“åŒ…æœºå¯†ï¼ˆä¸ºäº†é¿å¼€ workflow_call 10 æ¡ secret é™åˆ¶ï¼‰
            const deploySecrets = Buffer.from(JSON.stringify({
              SERVER_HOST: process.env.SERVER_HOST,
              SERVER_PORT: process.env.SERVER_PORT,
              SERVER_USER: process.env.SERVER_USER,
              SERVER_KEY : process.env.SERVER_KEY,
              DEPLOY_CENTER_PAT: process.env.DEPLOY_CENTER_PAT
            })).toString('base64');

            // 2. Nginx ç‰‡æ®µç”¨æ¨¡æ¿å­—ç¬¦ä¸²å†™æ›´æ˜“è¯»
            const nginxConfig = `
              location /docs/ {
                alias /srv/static/axi-docs/;
                index index.html;
                try_files $uri $uri/ /docs/index.html;

                add_header Cache-Control "no-cache, no-store, must-revalidate" always;
                add_header Pragma        "no-cache" always;
                add_header Expires       "0"        always;
              }

              location = /docs { return 301 /docs/; }
            `.trim();

            console.log('ğŸš€  è§¦å‘ axi-deploy/main-deployment.yml â€¦');

            await github.rest.actions.createWorkflowDispatch({
              owner: 'MoseLu',
              repo:  'axi-deploy',
              workflow_id: 'main-deployment.yml',
              ref: 'master',
              inputs: {
                project      : context.repo.repo,
                source_repo  : `${context.repo.owner}/${context.repo.repo}`,
                run_id       : process.env.RUN_ID,
                deploy_type  : 'static',
                nginx_config : nginxConfig,
                test_url     : 'https://redamancy.com.cn/docs/',
                deploy_secrets: deploySecrets
              }
            });

            console.log('âœ…  éƒ¨ç½²å·¥ä½œæµå·²æˆåŠŸè§¦å‘ï¼');
