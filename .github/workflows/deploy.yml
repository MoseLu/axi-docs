name: Build & Deploy Axi Docs

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-id: ${{ steps.upload.outputs.artifact-id }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v4
        
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: å®‰è£…ä¾èµ–
        run: pnpm install
        
      - name: æ„å»ºé¡¹ç›®
        run: pnpm docs:build
        
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        id: upload
        with:
          name: dist-axi-docs
          path: docs/.vitepress/dist/
          retention-days: 1

  trigger-deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
        run: |
          echo "ğŸ” æ£€æŸ¥æœåŠ¡å™¨é…ç½®..."
          echo "SERVER_HOST: ${{ secrets.SERVER_HOST }}"
          echo "SERVER_PORT: ${{ secrets.SERVER_PORT }}"
          echo "SERVER_USER: ${{ secrets.SERVER_USER }}"
          echo "SERVER_KEY é•¿åº¦: ${{ secrets.SERVER_KEY != '' && 'å·²è®¾ç½®' || 'æœªè®¾ç½®' }}"
          
          # æ£€æŸ¥å¿…éœ€çš„é…ç½®
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then
            echo "âŒ SERVER_HOST æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_PORT }}" ]; then
            echo "âŒ SERVER_PORT æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_USER }}" ]; then
            echo "âŒ SERVER_USER æœªè®¾ç½®"
            exit 1
          fi
          
          if [ -z "${{ secrets.SERVER_KEY }}" ]; then
            echo "âŒ SERVER_KEY æœªè®¾ç½®"
            echo "è¯·åœ¨axi-docsä»“åº“çš„Settings > Secrets and variables > Actionsä¸­è®¾ç½®SERVER_KEY"
            exit 1
          fi
          
          echo "âœ… æœåŠ¡å™¨é…ç½®æ£€æŸ¥å®Œæˆ"
          
      - name: è§¦å‘éƒ¨ç½²
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DEPLOY_CENTER_PAT }}
          script: |
            try {
              console.log('ğŸš€ å¼€å§‹è§¦å‘éƒ¨ç½²...');
              console.log('ç›®æ ‡ä»“åº“: MoseLu/axi-deploy');
              console.log('å·¥ä½œæµ: external-deploy.yml');
              console.log('åˆ†æ”¯: master');
              
              // æ„å»ºserver_configï¼Œç¡®ä¿å¯†é’¥æ­£ç¡®ä¼ é€’
              const serverConfig = `${{ secrets.SERVER_HOST }}/${{ secrets.SERVER_PORT }}/${{ secrets.SERVER_USER }}/${{ secrets.SERVER_KEY }}`;
              console.log('æœåŠ¡å™¨é…ç½®é•¿åº¦:', serverConfig.length);
              
              const { data: response } = await github.rest.actions.createWorkflowDispatch({
                owner: 'MoseLu',
                repo: 'axi-deploy',
                workflow_id: 'external-deploy.yml',
                ref: 'master',
                inputs: {
                  project: 'axi-docs',
                  lang: 'static',
                  artifact_id: '${{ needs.build.outputs.artifact-id }}',
                  deploy_path: '/www/wwwroot/axi-docs',
                  start_cmd: 'echo "Axi Docs é™æ€ç½‘ç«™éƒ¨ç½²å®Œæˆï¼Œæ— éœ€å¯åŠ¨å‘½ä»¤"',
                  caller_info: '${{ github.repository }}/${{ github.ref_name }}/${{ github.sha }}',
                  server_config: serverConfig
                }
              });
              
              console.log('âœ… Axi Docs éƒ¨ç½²å·²æˆåŠŸè§¦å‘!');
              console.log('å“åº”çŠ¶æ€:', response ? 'æˆåŠŸ' : 'æ— æ•°æ®è¿”å›(æ­£å¸¸)');
              
              if (response) {
                console.log('å“åº”è¯¦æƒ…:', JSON.stringify(response, null, 2));
              }
              
            } catch (error) {
              console.error('âŒ è§¦å‘éƒ¨ç½²å¤±è´¥:', error.message);
              console.error('é”™è¯¯è¯¦æƒ…:', error);
              throw error;
            } 